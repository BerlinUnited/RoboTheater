<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- <link rel="icon" href="../../favicon.ico"> -->
    <link rel="canonical" href=".">

    <title>Robot Stage Control</title>
    
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="lib/bootstrap-3.4.1/css/bootstrap.min.css" >
    <!--<link rel="stylesheet" href="./lib/bootstrap-3.4.1/css/bootstrap-theme.min.css" > -->
    
    <script src="future-fortune.js"></script>
    <!-- Optional Bootstrap Theme -->
    
    <script src="lib/JoystickController/JoystickController.js"></script>
    
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="./lib/jquery-3.5.1.slim.min.js"></script>
  </head>

  <script>
    //const peerConnection = new RTCPeerConnection();
  
    // this is a global button group
    var buttonGroups = {
      "scenes": [],
      "animations": []
    };

    function blockingActionsExecutor(actions, groupName) {
    
      return (event) => {   
        group = buttonGroups[groupName];
        // disable all buttons in the group
        group.forEach((b) => b.addClass("disabled"));
        
        // NOTE: this is prepared for toggled buttons
        //$(event.target).removeClass("disabled");
        //$(event.target).addClass("btn-danger");
      
        // send all actions
        actions.forEach(({service, call}) => send(service, call, (result) => {
          // for debug
          //console.log(result);
          
          //enable all buttons in the group when the result comes back
          group.forEach((b) => b.removeClass("disabled"));
        }));
        
        // this prevents the page to scrolling when clicked
        return false;
      }
    }
    
    function nonBlockingActionsExecutor(actions) {
      return (event) => {
        // send all actions
        actions.forEach(({service, call}) => send(service, call, (result) => { 
          // for debug
          //console.log(result);
        }));
        
        // this prevents the page to scrolling when clicked
        return false;
      }
    }
    
    function loadHeader(data) {
      var navbar = $("#navbar-right");

      for(var e of data) {
        var anchor = $('<a class="btn btn-default" href="#">' + e['title'] + '</a>')
          .click( nonBlockingActionsExecutor(e['actions']) );
        
        // collect buttons to be blocked
        //buttons.push(anchor);
        
        var li = $('<li style="padding-right:1em;"></li>').append(anchor);
        
        navbar.append(li);
      }
    }
    
    
    
    function loadScene(data) {
      
      // HACK: treat animations differently
      if(data['title'] == 'Animations') {
        loadAnimations(data);
        return;
      }
    
      // style="max-height: 30em; overflow-y: auto;"
      var sceneHtml = 
        '<div class="col-md-12"> \
          <div class="panel panel-primary"> \
            <div class="panel-heading"><strong>{{title}}</strong></div> \
            <div class="panel-body"> \
            </div> \
            <div class="panel-footer"> \
              <p><a id="animations_stop" class="btn btn-danger" href="#" role="button" onclick="behavior_stop(); return false"> \
                <span class="glyphicon glyphicon-stop" aria-hidden="true"></span> STOP LAST BEHAVIOR \
              </a></p> \
            </div> \
          </div> \
        </div>';
      
      sceneHtml = sceneHtml.replace(/{{title}}/ig, data['title']);
      
      var scene = $(sceneHtml);
      
      // create a button list
      var buttonList = $('<ul class="list-group"></ul>').appendTo($(".panel-body", scene));
      for(var e of data['items']) {
        var anchor = $('<a class="btn btn-default" href="#"><span class="glyphicon glyphicon-play"></span> ' + e['title'] + '</a>')
          .click(blockingActionsExecutor(e['actions'], 'scenes'));
        
        // HACK: ad too group manualy
        buttonGroups['scenes'].push(anchor);
        
        $('<li class="list-group-item"></li>').append(anchor).appendTo(buttonList);
      }
      
      // HACK
      $("#container").append( scene );
      
      console.log(data);
    }
    
    function loadPageFromJson(data) {
      console.log(data);
      
      loadHeader(data['header']);
      
      data['scenes'].forEach(loadScene);
    }
    
    
    function loadAnimations(data) {
      var scene = $("#animations");

      for(var e of data['items']) {
        var anchor = $('<a class="btn btn-default btn-lg" href="#" style="margin: 0.5em 0.5em;"><span class="glyphicon glyphicon-play"></span> ' + e['title'] + ' </a> ')
            .click(blockingActionsExecutor(e['actions'], 'animations'));
        scene.append(anchor);
        
        // HACK: ad too group manualy
        buttonGroups['animations'].push(anchor);
      }
    }
    
    /*
    function loadAnimations() {
      send("ALBehaviorManager", ["getInstalledBehaviors"], function(data) 
      {
        var s = "{'data':" + data + "}";
        const searchRegExp = new RegExp("'", 'g');
        s = s.replace(searchRegExp,"\"");
        console.log(s);
        var obj = JSON.parse(s);
        console.log(obj);
        
        var animations = $("#animations");
        for(a of obj['data']) {
          if(a.startsWith('animations')) {
            // remove 'animations/' at the beginning
            a = a.substring('animations'.length+1);
            var item = '<li class="list-group-item"><a class="btn btn-default" href="#" onclick="behavior(\'' + a + '\'); return false"><span class="glyphicon glyphicon-play"></span> ' + a +'</a></li>';
            animations.append(item)
          } 
        }
      });
    }
    */
  </script>
  
  
  <script>
    // hack:
    var last_behavior = '';
  
    function init() {
      // initialize the page content from a json file
      loadPageFromJson(pageData);
    }
    
    // runBehavior
    function behavior(path) { 
      behavior_stop(last_behavior);
      send("ALBehaviorManager", ["startBehavior", path]); 
      last_behavior = path; 
    }
    
    function behavior_stop(path) { 
      alert("Stopping behavior is not implemented yet. Do we want to have it?");
      if(path == null) {
        path = last_behavior;
      }
      send("ALBehaviorManager", ["stopBehavior", path]); 
    }
    
    // say
    // NOTE: pCall - is an asynchroneous (non blocking) call
    function say(message) { send("ALTextToSpeech", ["pCall", "say", message]); }
    function say_animated(message) { send("ALAnimatedSpeech", ["pCall", "say", message, "{\"speakingMovementMode\":contextual}"]); }
    function say_stop(message) { send("ALTextToSpeech", ["stopAll"]); }
    
    function send(proxy, call, handler) {
      var xhr = new XMLHttpRequest();

      var data = JSON.stringify({
        "proxy": proxy,
        "call": call
      });
      console.log(data);
      
      xhr.open("POST", "naoqi", true);
      
      xhr.onload = function (e) {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            console.log(xhr.responseText);
            
            if(typeof handler !== "undefined") {
              handler(xhr.responseText);
            }
          } else {
            console.error(xhr.statusText);
          }
        }
      };
      
      xhr.onerror = function (e) {
        console.error(xhr.statusText);
      };
      
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.send(data); 
    }
    </script>
    
  <script>
    window.addEventListener('keydown', doKeyDown, false);
    window.addEventListener('keyup', doKeyUp, false);

    // arrows
    var code_left  = 37;
    var code_up    = 38; 
    var code_right = 39; 
    var code_down  = 40;
    
    var code_l     = 65;
    var code_r     = 68;
    
    var left  = 0;
    var right = 0;
    var up    = 0;
    var down  = 0;
    
    // L/R buttons
    var l     = 0;
    var r     = 0;
    
    var speedForward  = 1.0;
    var speedBackward = 1.0;
    var speedStrave   = 1.0;
    var speedTurn     = 1.0;
    
    window.addEventListener("keydown", function(e) {
        // space and arrow keys
        if([code_left, code_right, code_up, code_down, code_l, code_r].indexOf(e.keyCode) > -1) {
            e.preventDefault();
        }
    }, false);
    
    function doKeyDown(e)
    {
      console.log(e);
			if (e.keyCode == code_up)    { up    = 1; }
			if (e.keyCode == code_down)  { down  = 1; }
      
			if (e.keyCode == code_left)  { left  = 1; }
			if (e.keyCode == code_right) { right = 1; }   

      if (e.keyCode == code_l)     { l = 1; }
			if (e.keyCode == code_r)     { r = 1; }        
		}
    
    function doKeyUp(e)
    {
			if (e.keyCode == code_up)    { up    = 0; }
			if (e.keyCode == code_down)  { down  = 0; }
      
			if (e.keyCode == code_left)  { left  = 0; }
			if (e.keyCode == code_right) { right = 0; }   

      if (e.keyCode == code_l)     { l = 0; }
			if (e.keyCode == code_r)     { r = 0; } 
		}
    
    var moveState = 0;
    var lastMoveState = 0;
    
    function sendMotionCommand() {
      var move_x = up * speedForward - down * speedBackward;
      var move_y = l * speedStrave - r * speedStrave;
      var move_r = left * speedTurn - right * speedTurn;
      send("ALMotion", ["moveToward", move_x, move_y, move_r]);
    }
    
    function processMove() {
      lastMoveState = moveState;
      moveState = left + right + up + down + l + r;
      
      if(moveState > 0) {
        console.log([left, right, up, down, l, r]);
        sendMotionCommand();
      } else if(lastMoveState > 0) {
        // stop
        console.log([left, right, up, down, l, r]);
        sendMotionCommand();
      }
    }
    
    setInterval(processMove, 100);
    
    </script>
    
  <body onload="init()">

    <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Future Fortune Stage Control</a>
        </div>
        
        <div id="navbar" class="navbar-collapse collapse">
          <ul id="navbar-left" class="nav navbar-nav">
            <!--<li class="active"><a href="#">Home</a></li>-->
          </ul>
          
          <ul id="navbar-right" class="nav navbar-nav navbar-right">
            <!--<li><a href="#" onclick="auto_mode('MoveContextually'); say('MoveContextually'); return false">MoveContextually</a></li>-->
          </ul>
          
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    
    
    <div class="container-fluid">
    
      <div class="page-header">
        <h1></h1>
      </div>
      
      <div class="row">
      
        <div class="col-md-6" style="height: 80%; overflow-y: auto;">
          <div id="container" class="row">
            
          </div>
        </div>
        
        <!-- animations -->
        <div class="col-md-6">
          <div id="panel-animations" class="panel panel-primary">
            <div class="panel-heading">Animations</div>
            <div class="panel-body" style="max-height: 50%; overflow-y: auto;" id="animations">
              <!--<ul class="list-group" id="animations"><ul>-->
            </div>
            <div class="panel-footer">
              <p><a id="animations_stop" class="btn btn-danger" href="#" role="button" onclick="behavior_stop(); return false">
                <span class="glyphicon glyphicon-stop" aria-hidden="true"></span> STOP LAST BEHAVIOR
              </a></p>
            </div>
          </div>
        </div>
        
        <!-- Move -->
        <!--
        <div class="col-md-6">
          <div class="fixed-bottom">
            <div class="panel panel-primary">
                <div class="panel-heading">Move</div>
                <div class="panel-body" style="max-height: 30em; overflow-y: auto;">
                  
                  <div id="status1">Joystick: </div>
                  
                  <div style="border: 0px solid red; width: 128px; position: fixed; bottom: 50px; right: 50px;">
                    <img src="lib/JoystickController/images/joystick-base.png"/>
                    <div id="stick1" style="position: absolute; left:32px; top:32px;">
                      <img src="lib/JoystickController/images/joystick-red.png"/>		
                    </div>
                  </div>
                  
                </div>
              </div>
          </div>
        </div>
        -->
      
      </div><!-- /.row -->
      
    </div><!-- /.container -->
    

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!--<script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>-->
    <script src="./lib/bootstrap-3.4.1/js/bootstrap.min.js"></script>
    
    <!--
    <script>
      // joystick
      let joystick1 = new JoystickController("stick1", 64, 8);
      
      function update()
      {
        if( joystick1.active ) {
          document.getElementById("status1").innerText = "Joystick 1: " + JSON.stringify(joystick1.value);
          send("ALMotion", ["moveToward", joystick1.value['y'], 0.0, -joystick1.value['x']]);
        }
      }
      
      // hack, make better
      function stop()
      {
        if( !joystick1.active ) {
          send("ALMotion", ["moveToward", joystick1.value['y'], 0.0, -joystick1.value['x']]);
        }
      }
      
      // read values
      //setInterval(update, 100);
      //setInterval(stop, 1000);
      
    </script>
    -->
  </body>
</html>
